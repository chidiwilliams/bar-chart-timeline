<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Animated Bar Chart</title>
  </head>
  <body>
    <h3>Animated Bar Chart</h3>
    <form action="" style="margin-bottom: 20px; ">
      <input
        type="number"
        name="num_categories"
        style="height: 40px; box-sizing: border-box; font-size: 1rem;"
        value="3"
      />
      <button type="submit" style="height: 40px; font-size: 1rem;">
        Randomize
      </button>
    </form>

    <canvas id="canvas" width="1000" style="border: solid 1px #000;"></canvas>

    <script>
      const BAR_WIDTH = 700;
      const BAR_MARGIN = 10;
      const BAR_HEIGHT = 40;
      const FONT_HEIGHT = 16;
      const BAR_LABEL_PADDING = 10;
      const FONT_STYLE = 'bold 16px Arial';
      const FRAMES_PER_SECOND = 50;

      function drawGraph({ categories }) {
        const canvas = document.getElementById('canvas');
        canvas.height = calculateTotalCanvasHeight(categories.length);

        const numSets = categories[0].values.length;
        for (let setIndex = 0; setIndex < numSets; setIndex++) {
          for (
            let frameIndex = 0;
            frameIndex < FRAMES_PER_SECOND;
            frameIndex++
          ) {
            // Only compute first frame of last set
            if (!isAdditionalFrameAtLastSet(setIndex, numSets, frameIndex)) {
              const delay = (setIndex + frameIndex / FRAMES_PER_SECOND) * 1000;
              const values = getValuesForSet(categories, setIndex, frameIndex);
              setTimeout(() => {
                drawCanvas(values, canvas);
              }, delay);
            }
          }
        }
      }

      function getCategoryNames(categories) {
        return categories.map(({ name }) => name);
      }

      function isAdditionalFrameAtLastSet(setIndex, numSets, frameIndex) {
        return setIndex === numSets - 1 && frameIndex !== 0;
      }

      function getValuesForSet(categories, setIndex, frameIndex) {
        return categories.map((category) => {
          const value = category.values[setIndex];

          let diff = 0;
          // Accessing next value if there are no other frames after the value
          // would cause array out of bounds on category.
          if (frameIndex > 0) {
            const nextValue = category.values[setIndex + 1];
            diff = nextValue - value;
          }

          return {
            value: value + (frameIndex / FRAMES_PER_SECOND) * diff,
            name: category.name,
          };
        });
      }

      function drawCanvas(values, canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

        totalValue = getTotalValue(values);

        values
          .sort((a, b) => b.value - a.value)
          .forEach(({ value, name }, id) => {
            ctx.beginPath();
            const yMargin = (BAR_HEIGHT + BAR_MARGIN) * id;
            const barWidth = getBarWidth(value, totalValue, BAR_WIDTH);
            ctx.rect(0, yMargin, barWidth, BAR_HEIGHT);
            ctx.fill();

            ctx.textBaseline = 'top';
            ctx.font = FONT_STYLE;
            const label = `${formatLabelValue(value)} - ${name}`;
            ctx.fillText(
              label,
              barWidth + BAR_LABEL_PADDING,
              yMargin + BAR_HEIGHT / 2 - FONT_HEIGHT / 2,
            );
          });
      }

      function formatLabelValue(num) {
        return (
          num
            .toString()
            // truncate to 2 decimal places
            .match(/^-?\d+(?:\.\d{0,2})?/)[0]
        );
      }

      function getBarWidth(value, totalValue, maxBarWidth) {
        return (value / totalValue) * maxBarWidth;
      }

      function getTotalValue(vals) {
        let s = 0;
        for (let i = 0; i < vals.length; i++) {
          const v = vals[i].value;
          s += v;
        }
        return s;
      }

      function calculateTotalCanvasHeight(numElements) {
        return numElements * BAR_HEIGHT + (numElements - 1) * BAR_MARGIN;
      }

      const url = new URL(document.location.href);
      if (url.searchParams.has('num_categories')) {
        const numCategories = Number(url.searchParams.get('num_categories'));
        if (!isNaN(numCategories) && numCategories > 0) {
          drawGraph({
            categories: [...Array(numCategories)].map((_, i) => ({
              name: `Category ${i + 1}`,
              values: [...Array(30)].map(() => Math.random()),
            })),
          });
        }
      }
    </script>
  </body>
</html>
